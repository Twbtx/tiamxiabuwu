local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local DragUI = Instance.new("ScreenGui")
DragUI.Name = "MoneyFarmUI"
DragUI.Parent = playerGui
DragUI.ResetOnSpawn = false
DragUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 320, 0, 400)
MainFrame.Position = UDim2.new(0.1, 0, 0.1, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = DragUI

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

local DragBar = Instance.new("Frame")
DragBar.Name = "DragBar"
DragBar.Size = UDim2.new(1, 0, 0, 35)
DragBar.Position = UDim2.new(0, 0, 0, 0)
DragBar.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
DragBar.BorderSizePixel = 0
DragBar.Parent = MainFrame

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "TitleLabel"
TitleLabel.Size = UDim2.new(1, -40, 1, 0)
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "金币农场 v2.0"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 16
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = DragBar

local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 25, 0, 25)
CloseButton.Position = UDim2.new(1, -30, 0, 5)
CloseButton.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Text = "X"
CloseButton.TextSize = 14
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Parent = DragBar

local ContentFrame = Instance.new("Frame")
ContentFrame.Name = "ContentFrame"
ContentFrame.Size = UDim2.new(1, 0, 1, -35)
ContentFrame.Position = UDim2.new(0, 0, 0, 35)
ContentFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
ContentFrame.BorderSizePixel = 0
ContentFrame.Parent = MainFrame

local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Name = "ScrollFrame"
ScrollFrame.Size = UDim2.new(1, 0, 1, 0)
ScrollFrame.Position = UDim2.new(0, 0, 0, 0)
ScrollFrame.BackgroundTransparency = 1
ScrollFrame.BorderSizePixel = 0
ScrollFrame.ScrollBarThickness = 6
ScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(80, 80, 80)
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 600)
ScrollFrame.Parent = ContentFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0, 12)
UIListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Parent = ScrollFrame

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "StatusLabel"
StatusLabel.Size = UDim2.new(0.9, 0, 0, 35)
StatusLabel.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
StatusLabel.Text = "状态: 准备就绪 | 执行次数: 0"
StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
StatusLabel.TextSize = 14
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.LayoutOrder = 1
StatusLabel.Parent = ScrollFrame

local function createButton(text, layoutOrder, color)
    local button = Instance.new("TextButton")
    button.Name = text .. "Button"
    button.Size = UDim2.new(0.9, 0, 0, 45)
    button.BackgroundColor3 = color
    button.Text = text
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 14
    button.Font = Enum.Font.GothamBold
    button.LayoutOrder = layoutOrder
    button.AutoButtonColor = true
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = button
    
    return button
end

local getMoneyBtn = createButton("获取金币 (1次)", 2, Color3.fromRGB(0, 150, 0))
getMoneyBtn.Parent = ScrollFrame

local stopExecuteBtn = createButton("停止执行", 3, Color3.fromRGB(150, 0, 0))
stopExecuteBtn.Parent = ScrollFrame

local customMoneyFrame = Instance.new("Frame")
customMoneyFrame.Name = "CustomMoneyFrame"
customMoneyFrame.Size = UDim2.new(0.9, 0, 0, 100)
customMoneyFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
customMoneyFrame.LayoutOrder = 4
customMoneyFrame.Parent = ScrollFrame

local customMoneyTitle = Instance.new("TextLabel")
customMoneyTitle.Name = "CustomMoneyTitle"
customMoneyTitle.Size = UDim2.new(1, 0, 0, 25)
customMoneyTitle.Position = UDim2.new(0, 0, 0, 5)
customMoneyTitle.BackgroundTransparency = 1
customMoneyTitle.Text = "自定义金币获取"
customMoneyTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
customMoneyTitle.TextSize = 14
customMoneyTitle.Font = Enum.Font.GothamBold
customMoneyTitle.Parent = customMoneyFrame

local timesInput = Instance.new("TextBox")
timesInput.Name = "TimesInput"
timesInput.Size = UDim2.new(0.6, 0, 0, 35)
timesInput.Position = UDim2.new(0.05, 0, 0, 35)
timesInput.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
timesInput.TextColor3 = Color3.fromRGB(255, 255, 255)
timesInput.Text = "100"
timesInput.PlaceholderText = "输入次数"
timesInput.TextSize = 14
timesInput.Font = Enum.Font.Gotham
timesInput.Parent = customMoneyFrame

local executeCustomBtn = Instance.new("TextButton")
executeCustomBtn.Name = "ExecuteCustomBtn"
executeCustomBtn.Size = UDim2.new(0.3, 0, 0, 35)
executeCustomBtn.Position = UDim2.new(0.67, 0, 0, 35)
executeCustomBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 200)
executeCustomBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
executeCustomBtn.Text = "执行"
executeCustomBtn.TextSize = 14
executeCustomBtn.Font = Enum.Font.GothamBold
executeCustomBtn.Parent = customMoneyFrame

local upgrade1Btn = createButton("升级类型 1 (true)", 5, Color3.fromRGB(200, 100, 0))
upgrade1Btn.Parent = ScrollFrame

local upgrade2Btn = createButton("升级类型 2 (true)", 6, Color3.fromRGB(200, 100, 0))
upgrade2Btn.Parent = ScrollFrame

local upgrade3Btn = createButton("升级类型 1 (false)", 7, Color3.fromRGB(150, 80, 0))
upgrade3Btn.Parent = ScrollFrame

local upgrade4Btn = createButton("升级类型 2 (false)", 8, Color3.fromRGB(150, 80, 0))
upgrade4Btn.Parent = ScrollFrame

local upgrade5Btn = createButton("升级类型 3 (true)", 9, Color3.fromRGB(180, 90, 0))
upgrade5Btn.Parent = ScrollFrame

local upgrade6Btn = createButton("升级类型 3 (false)", 10, Color3.fromRGB(130, 70, 0))
upgrade6Btn.Parent = ScrollFrame

local upgrade7Btn = createButton("升级类型 4 (true)", 11, Color3.fromRGB(160, 80, 0))
upgrade7Btn.Parent = ScrollFrame

local upgrade8Btn = createButton("升级类型 4 (false)", 12, Color3.fromRGB(120, 60, 0))
upgrade8Btn.Parent = ScrollFrame

local totalCalls = 0
local isExecuting = false
local stopRequested = false

local function updateStatus(message, color)
    StatusLabel.Text = "状态: " .. message .. " | 执行次数: " .. totalCalls
    StatusLabel.TextColor3 = color
end

local function getMoney()
    local success, result = pcall(function()
        game:GetService("ReplicatedStorage").Events.ClickMoney:FireServer()
    end)
    
    if success then
        totalCalls += 1
        return true
    else
        warn("获取金币失败: " .. tostring(result))
        return false
    end
end

local function stopExecution()
    if isExecuting then
        stopRequested = true
        updateStatus("正在停止...", Color3.fromRGB(255, 165, 0))
    end
end

local function getMoneyCustomTimes()
    if isExecuting then return end
    
    local timesText = timesInput.Text
    local times = tonumber(timesText)
    
    if not times or times <= 0 then
        updateStatus("请输入有效次数", Color3.fromRGB(255, 0, 0))
        return
    end
    
    if times > 10000000 then
        updateStatus("次数过多，请减少", Color3.fromRGB(255, 0, 0))
        return
    end
    
    isExecuting = true
    stopRequested = false
    executeCustomBtn.Text = "执行中..."
    executeCustomBtn.BackgroundColor3 = Color3.fromRGB(0, 80, 150)
    
    spawn(function()
        local successCount = 0
        local failCount = 0
        
        updateStatus("开始获取金币 (" .. times .. "次)", Color3.fromRGB(255, 165, 0))
        
        for i = 1, times do
            if stopRequested then
                break
            end
            
            if getMoney() then
                successCount += 1
            else
                failCount += 1
            end
            
            if i % 5000 == 0 then
                updateStatus("进度: " .. i .. "/" .. times, Color3.fromRGB(255, 165, 0))
                wait(0.00005)
            end
        end
        
        isExecuting = false
        executeCustomBtn.Text = "执行"
        executeCustomBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 200)
        
        if stopRequested then
            updateStatus("已停止: 成功 " .. successCount .. " 次, 失败 " .. failCount .. " 次", Color3.fromRGB(255, 165, 0))
        else
            updateStatus("完成: 成功 " .. successCount .. " 次, 失败 " .. failCount .. " 次", 
                        failCount == 0 and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 165, 0))
        end
    end)
end

local function upgrade(type, value)
    local args = {
        [1] = type,
        [2] = value
    }
    
    local success, result = pcall(function()
        game:GetService("ReplicatedStorage").Events.Upgrade:FireServer(unpack(args))
    end)
    
    if success then
        totalCalls += 1
        updateStatus("升级成功 (类型 " .. type .. ", 值: " .. tostring(value) .. ")", Color3.fromRGB(0, 255, 0))
    else
        updateStatus("升级失败", Color3.fromRGB(255, 0, 0))
        warn("升级失败: " .. tostring(result))
    end
end

getMoneyBtn.MouseButton1Click:Connect(function()
    if getMoney() then
        updateStatus("金币获取成功", Color3.fromRGB(0, 255, 0))
    else
        updateStatus("金币获取失败", Color3.fromRGB(255, 0, 0))
    end
end)

stopExecuteBtn.MouseButton1Click:Connect(stopExecution)

executeCustomBtn.MouseButton1Click:Connect(getMoneyCustomTimes)

upgrade1Btn.MouseButton1Click:Connect(function()
    upgrade(1, true)
end)

upgrade2Btn.MouseButton1Click:Connect(function()
    upgrade(2, true)
end)

upgrade3Btn.MouseButton1Click:Connect(function()
    upgrade(1, false)
end)

upgrade4Btn.MouseButton1Click:Connect(function()
    upgrade(2, false)
end)

upgrade5Btn.MouseButton1Click:Connect(function()
    upgrade(3, true)
end)

upgrade6Btn.MouseButton1Click:Connect(function()
    upgrade(3, false)
end)

upgrade7Btn.MouseButton1Click:Connect(function()
    upgrade(4, true)
end)

upgrade8Btn.MouseButton1Click:Connect(function()
    upgrade(4, false)
end)

local dragging = false
local dragStart
local startPos

DragBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        local connection
        connection = input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
                connection:Disconnect()
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(
            startPos.X.Scale, 
            startPos.X.Offset + delta.X,
            startPos.Y.Scale, 
            startPos.Y.Offset + delta.Y
        )
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    DragUI:Destroy()
end)

local function setupHoverEffect(button, normalColor, hoverColor)
    button.MouseEnter:Connect(function()
        if not string.find(button.Text, "执行中") then
            button.BackgroundColor3 = hoverColor
        end
    end)
    
    button.MouseLeave:Connect(function()
        if not string.find(button.Text, "执行中") then
            button.BackgroundColor3 = normalColor
        end
    end)
end

setupHoverEffect(getMoneyBtn, Color3.fromRGB(0, 150, 0), Color3.fromRGB(0, 180, 0))
setupHoverEffect(stopExecuteBtn, Color3.fromRGB(150, 0, 0), Color3.fromRGB(180, 0, 0))
setupHoverEffect(executeCustomBtn, Color3.fromRGB(0, 120, 200), Color3.fromRGB(0, 150, 230))
setupHoverEffect(upgrade1Btn, Color3.fromRGB(200, 100, 0), Color3.fromRGB(230, 120, 0))
setupHoverEffect(upgrade2Btn, Color3.fromRGB(200, 100, 0), Color3.fromRGB(230, 120, 0))
setupHoverEffect(upgrade3Btn, Color3.fromRGB(150, 80, 0), Color3.fromRGB(180, 100, 0))
setupHoverEffect(upgrade4Btn, Color3.fromRGB(150, 80, 0), Color3.fromRGB(180, 100, 0))
setupHoverEffect(upgrade5Btn, Color3.fromRGB(180, 90, 0), Color3.fromRGB(210, 110, 0))
setupHoverEffect(upgrade6Btn, Color3.fromRGB(130, 70, 0), Color3.fromRGB(160, 90, 0))
setupHoverEffect(upgrade7Btn, Color3.fromRGB(160, 80, 0), Color3.fromRGB(190, 100, 0))
setupHoverEffect(upgrade8Btn, Color3.fromRGB(120, 60, 0), Color3.fromRGB(150, 80, 0))

CloseButton.MouseEnter:Connect(function()
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
end)

CloseButton.MouseLeave:Connect(function()
    CloseButton.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
end)

DragBar.MouseEnter:Connect(function()
    DragBar.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
end)

DragBar.MouseLeave:Connect(function()
    DragBar.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
end)

print("加载完成")